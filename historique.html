<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Historique des Transactions</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    /* Reset & global */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #e9f1f7;
      color: #2c3e50;
      margin: 0;
      padding: 20px 20px;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .container {
      width: 100%;
      max-width: 480px;
      padding: 0 15px;
    }
    h2 {
      text-align: center;
      font-weight: 800;
      font-size: 2rem;
      color: #003366;
      margin-bottom: 30px;
      user-select: none;
    }

    /* Historique */
    #historyList {
      display: flex;
      flex-direction: column-reverse; /* Le plus récent en haut */
      gap: 20px;
      min-height: 200px;
      user-select: text;
    }

    .history-item {
      background: #ffffffcc;
      padding: 20px 25px;
      border-radius: 16px;
      box-shadow: 0 6px 16px rgba(0, 82, 155, 0.1);
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 12px;
    }
    .history-info {
      flex: 1 1 45%;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 150px;
    }
    .info-group {
      display: flex;
      justify-content: space-between;
      font-size: 1rem;
      font-weight: 600;
      color: #004080;
    }
    .info-label {
      color: #00529b;
      user-select: none;
    }
    .info-value {
      font-weight: 700;
      color: #00264d;
      text-align: right;
      word-break: break-word;
    }

    .processing-info {
      flex-basis: 100%;
      font-weight: 600;
      color: #00529b;
      margin-top: 8px;
      font-size: 0.95rem;
    }
    .reject-reason {
      flex-basis: 100%;
      color: #b00020;
      font-weight: 700;
      margin-top: 8px;
      font-size: 0.95rem;
      user-select: text;
    }
    .status {
      flex-basis: 100%;
      margin-top: 12px;
      padding: 9px 20px;
      border-radius: 50px;
      font-weight: 700;
      font-size: 1.1rem;
      user-select: none;
      text-align: center;
      max-width: fit-content;
    }
    .status-success {
      background-color: #43a047;
      color: #e6f4ea;
    }
    .status-pending {
      background-color: #f9a825;
      color: #fff8e1;
    }
    .status-failed {
      background-color: #d32f2f;
      color: #fbe9e7;
    }

    /* Texte aucunes données ou erreurs */
    .no-records {
      background: #f0f4fa;
      border: 2px dashed #a3c1f7;
      border-radius: 16px;
      padding: 25px;
      color: #768ba1;
      font-weight: 700;
      font-size: 1.1rem;
      text-align: center;
      user-select: none;
    }

    /* Notification */
    #notification {
      position: fixed;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #43a047;
      color: white;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 1rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 1000;
      user-select: none;
      max-width: 90vw;
      text-align: center;
    }
    #notification.error {
      background-color: #d32f2f;
    }
    #notification.show {
      opacity: 1;
      pointer-events: auto;
    }

    /* Loading overlay */
    .loading {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.7);
      justify-content: center;
      align-items: center;
      z-index: 1100;
      user-select: none;
      user-drag: none;
    }
    .loading.active {
      display: flex;
    }
    .loading .spinner {
      border: 6px solid #eee;
      border-top: 6px solid #00529b;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0);}
      100% { transform: rotate(360deg);}
    }

    /* Responsive */
    @media (max-width: 480px) {
      .history-info {
        flex-basis: 100%;
      }
      .history-item {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <main class="container" role="main" aria-label="Historique des transactions">
    <h2>Votre historique de transactions</h2>
    <div id="historyList" aria-live="polite">
      <div class="no-records">Chargement des transactions...</div>
    </div>
  </main>

  <div id="notification" role="alert" aria-live="assertive"></div>
  <div class="loading" aria-hidden="true"><div class="spinner" aria-label="Chargement en cours"></div></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getDatabase,
    ref,
    get,
    set,
    update,
    onValue,
    query,
    orderByChild,
    equalTo,
    runTransaction
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  // === Configuration et initialization Firebase ===
  const firebaseConfig = {
    apiKey: "AIzaSyBbnOxwcCXHAHJWxPw90YGvSuPCOyp6-lA",
    authDomain: "nescafe-cba7a.firebaseapp.com",
    databaseURL: "https://nescafe-cba7a-default-rtdb.firebaseio.com",
    projectId: "nescafe-cba7a",
    storageBucket: "nescafe-cba7a.firebasestorage.app",
    messagingSenderId: "91209018725",
    appId: "1:91209018725:web:adb0d2a8b458591c8a058c"
  };


    try {
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getDatabase(app);
      const creditedTransactions = new Set();

      function showLoading() {
        document.querySelector('.loading').classList.add('active');
      }

      function hideLoading() {
        document.querySelector('.loading').classList.remove('active');
      }

      function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = 'show' + (type === 'error' ? ' error' : '');
        notification.style.background = type === 'success' ? '#43a047' : '#d32f2f';
        notification.style.display = 'block';
        setTimeout(() => {
          notification.className = '';
          notification.style.display = 'none';
        }, 3000);
      }

      async function updateUserBalance(userId, amount, transactionId) {
        if (creditedTransactions.has(transactionId)) return;

        try {
          const userRef = ref(db, `users/${userId}`);
          const snapshot = await get(userRef);

          if (snapshot.exists()) {
            const userData = snapshot.val();
            const currentBalance = userData.solde || 0;
            const newBalance = currentBalance + parseFloat(amount);

            const updates = {};
            updates[`users/${userId}/solde`] = newBalance;
            updates[`transactions/${transactionId}/credited`] = true;

            await set(ref(db), updates);
            creditedTransactions.add(transactionId);
          }
        } catch (error) {
          console.error('Erreur de mise à jour du solde:', error);
        }
      }

      function formatDate(dateString) {
        try {
          const date = new Date(dateString);
          if (isNaN(date.getTime())) throw new Error('Date invalide');

          return new Intl.DateTimeFormat('fr-FR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }).format(date).replace(',', ' à');
        } catch {
          return 'Date non disponible';
        }
      }

      function getStatusClass(status) {
        const statusClasses = {
          success: 'status-success',
          pending: 'status-pending',
          failed: 'status-failed'
        };
        return statusClasses[status] || '';
      }

      function translateStatus(status) {
        const translations = {
          success: 'Crédité',
          pending: 'En cours de vérification',
          failed: 'Échec'
        };
        return translations[status] || status;
      }

      function createHistoryItem(transaction, userId) {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        historyItem.dataset.transactionId = transaction.transactionId || '';

        if (transaction.status === 'success' && !transaction.credited && userId) {
          updateUserBalance(userId, transaction.amount || 0, transaction.transactionId);
        }

        historyItem.innerHTML = `
          <div class="history-info">
            <div class="info-group">
              <span class="info-label">Montant</span>
              <span class="info-value">${transaction.amount || 0} FCFA</span>
            </div>
            <div class="info-group">
              <span class="info-label">Numéro rechargé</span>
              <span class="info-value">${transaction.phone || 'Non spécifié'}</span>
            </div>
          </div>
          <div class="history-info">
            <div class="info-group">
              <span class="info-label">Opérateur</span>
              <span class="info-value">${transaction.operator ? transaction.operator.toUpperCase() : 'Non spécifié'}</span>
            </div>
            <div class="info-group">
              <span class="info-label">ID Transaction</span>
              <span class="info-value">${transaction.transactionId || 'Non spécifié'}</span>
            </div>
          </div>
          <div class="history-info">
            <div class="info-group">
              <span class="info-label">Date</span>
              <span class="info-value">${formatDate(transaction.date)}</span>
            </div>
            <div class="info-group">
              <span class="info-label">Numéro de paiement</span>
              <span class="info-value">${transaction.userPaymentNumber || 'Non spécifié'}</span>
            </div>
            ${transaction.processedDate ? `
              <div class="processing-info">Traité le ${formatDate(transaction.processedDate)}</div>
            ` : ''}
            ${transaction.status === 'failed' && transaction.rejectReason ? `
              <div class="reject-reason">Motif du rejet: ${transaction.rejectReason}</div>
            ` : ''}
            <div class="status ${getStatusClass(transaction.status || 'pending')}">
              ${translateStatus(transaction.status || 'pending')}
            </div>
          </div>
        `;
        return historyItem;
      }

      function displayTransactions(transactions, userId) {
        const historyList = document.getElementById('historyList');
        if (!historyList) return;

        if (!transactions || Object.keys(transactions).length === 0) {
          historyList.innerHTML = '<div class="no-records">Aucune transaction trouvée</div>';
          return;
        }

        const userTransactions = Object.entries(transactions)
          .filter(([_, transaction]) => transaction.userId === userId)
          .map(([id, transaction]) => ({ ...transaction, id }))
          .sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));

        if (userTransactions.length === 0) {
          historyList.innerHTML = '<div class="no-records">Aucune transaction trouvée</div>';
          return;
        }

        const fragment = document.createDocumentFragment();
        let hasNewItems = false;

        userTransactions.forEach(transaction => {
          const existingItem = document.querySelector(
            `[data-transaction-id="${transaction.transactionId}"]`
          );

          if (existingItem) {
            const newItem = createHistoryItem(transaction, userId);
            if (existingItem.innerHTML !== newItem.innerHTML) {
              existingItem.parentNode.replaceChild(newItem, existingItem);
            }
          } else {
            fragment.appendChild(createHistoryItem(transaction, userId));
            hasNewItems = true;
          }
        });

        if (hasNewItems) {
          if (historyList.children.length === 0) {
            historyList.appendChild(fragment);
          } else {
            historyList.insertBefore(fragment, historyList.firstChild);
          }
        }

        // Nettoyage des anciens éléments éventuellement supprimés
        const currentIds = new Set(userTransactions.map(t => t.transactionId));
        Array.from(historyList.children).forEach(child => {
          const id = child.dataset.transactionId;
          if (id && !currentIds.has(id)) {
            child.remove();
          }
        });
      }

      onAuthStateChanged(auth, (user) => {
        const historyList = document.getElementById('historyList');
        if (!historyList) return;

        if (user) {
          const transactionsRef = query(
            ref(db, 'transactions'),
            orderByChild('userId'),
            equalTo(user.uid)
          );

          showLoading();

          const unsubscribe = onValue(transactionsRef, (snapshot) => {
            hideLoading();
            try {
              const transactions = snapshot.val();
              displayTransactions(transactions, user.uid);
            } catch (error) {
              console.error('Erreur lors de la récupération des transactions:', error);
              historyList.innerHTML = '<div class="no-records">Erreur lors du chargement des transactions</div>';
            }
          }, (error) => {
            hideLoading();
            console.error('Erreur Firebase:', error);
            historyList.innerHTML = '<div class="no-records">Erreur de connexion</div>';
          });
        } else {
          document.getElementById('historyList').innerHTML = '<div class="no-records">Veuillez vous connecter pour voir votre historique</div>';
          hideLoading();
        }
      });

    } catch (error) {
      console.error('Erreur d\'initialisation:', error);
      const historyList = document.getElementById('historyList');
      if (historyList) {
        historyList.innerHTML = '<div class="no-records">Erreur d\'initialisation de l\'application</div>';
      }
    }
  </script>
</body>
</html>
