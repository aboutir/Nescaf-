<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configuration Retrait</title>
  
  <style>
    /* Reset léger */
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 1rem;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      margin-bottom: 1rem;
      color: #0077cc;
    }
    form {
      background: white;
      padding: 1.5rem 2rem;
      border-radius: 10px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 0 15px rgb(0 0 0 / 0.1);
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: 600;
    }
    input[type="text"],
    input[type="tel"],
    input[type="password"] {
      width: 100%;
      margin-top: 0.4rem;
      padding: 0.6rem 0.8rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    input[type="text"]:focus,
    input[type="tel"]:focus,
    input[type="password"]:focus {
      border-color: #0077cc;
      outline: none;
    }
    #operatorSelector {
      margin-top: 1rem;
      padding: 0.6rem 0.8rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 500;
      color: #0077cc;
      background: #e6f0ff;
    }
    #operatorSelector:focus {
      outline: 2px solid #005fa3;
    }
    #selectedType {
      font-weight: 700;
    }
    button {
      margin-top: 1.5rem;
      width: 100%;
      padding: 0.75rem;
      font-size: 1.1rem;
      border: none;
      border-radius: 8px;
      background-color: #0077cc;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:disabled {
      background-color: #99c2e6;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background-color: #005fa3;
    }

    /* Message styles */
    #message > div {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 6px;
      text-align: center;
      font-weight: 600;
      font-size: 0.95rem;
      opacity: 0.95;
    }
    .message-error {
      background: #f8d7da;
      color: #842029;
      border: 1px solid #f5c2c7;
    }
    .message-success {
      background: #d1e7dd;
      color: #0f5132;
      border: 1px solid #badbcc;
    }

    /* Bottom sheet overlay */
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
      z-index: 999;
    }
    #overlay.active {
      opacity: 1;
      visibility: visible;
    }

    /* Bottom sheet container */
    #bottomSheet {
      position: fixed;
      bottom: -300px;
      left: 0;
      right: 0;
      background: white;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -4px 10px rgba(0,0,0,0.2);
      max-height: 300px;
      overflow-y: auto;
      transition: bottom 0.3s ease;
      z-index: 1000;
      padding: 1rem 1.5rem 1.5rem 1.5rem;
      display: flex;
      flex-direction: column;
    }
    #bottomSheet.active {
      bottom: 0;
    }

    /* Operator options */
    .operator {
      padding: 0.7rem 1rem;
      margin-bottom: 0.6rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      color: #0077cc;
    }
    .operator.selected {
      background-color: #0077cc;
      color: white;
      border-color: #005fa3;
    }
    .operator:focus {
      outline: 2px solid #005fa3;
    }

    /* Bottom Sheet buttons */
    #bottomSheetButtons {
      display: flex;
      justify-content: space-between;
      margin-top: auto;
    }
    #cancelBtn, #confirmBtn {
      font-weight: 700;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      padding: 0.6rem 1.2rem;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s;
    }
    #cancelBtn {
      background-color: #ccc;
      color: #444;
    }
    #cancelBtn:hover {
      background-color: #999;
    }
    #confirmBtn {
      background-color: #0077cc;
      color: white;
    }
    #confirmBtn:hover {
      background-color: #005fa3;
    }

    /* Responsive adjustments */
    @media (max-width: 480px) {
      form {
        padding: 1rem 1rem;
        max-width: 100%;
        border-radius: 0;
        box-shadow: none;
      }
      #bottomSheet {
        border-radius: 12px 12px 0 0;
        max-height: 250px;
      }
    }
  </style>
</head>
<body>

  <h1>Configuration Retrait</h1>

  <form id="withdrawalForm" novalidate>
    <label for="ownerName">Nom du propriétaire</label>
    <input type="text" id="ownerName" class="field-input" placeholder="Entrez le nom complet" required />

    <label for="phone">Numéro de compte</label>
    <input type="tel" id="phone" class="field-input" placeholder="Ex: 0123456789" pattern="[0-9]{8,15}" inputmode="tel" required />

    <label for="operatorSelector">Opérateur</label>
    <div id="operatorSelector" role="button" tabindex="0" aria-haspopup="listbox" aria-expanded="false" aria-labelledby="operatorLabel">
      <span id="selectedType">MTN</span>
      <span aria-hidden="true">&#9662;</span>
    </div>
    <input type="hidden" id="operator" name="operator" value="MTN" />

    <label for="code">Code de retrait</label>
    <input type="password" id="code" class="field-input" placeholder="Au moins 4 caractères" minlength="4" required />

    <button type="button" id="submitBtn">Enregistrer</button>

    <div id="message" aria-live="polite" aria-atomic="true"></div>
  </form>

  <!-- Bottom Sheet -->
  <div id="overlay" aria-hidden="true"></div>
  <section id="bottomSheet" aria-hidden="true" aria-label="Sélecteur d'opérateur">
    <div class="operator" tabindex="0" data-operator="MTN" role="option" aria-selected="true">MTN</div>
    <div class="operator" tabindex="0" data-operator="Orange" role="option" aria-selected="false">Orange</div>
    <div class="operator" tabindex="0" data-operator="Moov" role="option" aria-selected="false">Moov</div>
    <div class="operator" tabindex="0" data-operator="Airtel" role="option" aria-selected="false">Airtel</div>
    <div class="operator" tabindex="0" data-operator="Wave" role="option" aria-selected="false">Wave</div>
  
    <div id="bottomSheetButtons">
      <button type="button" id="cancelBtn">Annuler</button>
      <button type="button" id="confirmBtn">Confirmer</button>
    </div>
  </section>

  <script type="module">
    // === Import Firebase ===
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      get,
      update,
      push,
      set,
      onValue,
      query,
      orderByChild,
      equalTo,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

    // === Configuration et initialization Firebase ===
    const firebaseConfig = {
      apiKey: "AIzaSyBbnOxwcCXHAHJWxPw90YGvSuPCOyp6-lA",
      authDomain: "nescafe-cba7a.firebaseapp.com",
      databaseURL: "https://nescafe-cba7a-default-rtdb.firebaseio.com",
      projectId: "nescafe-cba7a",
      storageBucket: "nescafe-cba7a.firebasestorage.app",
      messagingSenderId: "91209018725",
      appId: "1:91209018725:web:adb0d2a8b458591c8a058c"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    document.addEventListener('DOMContentLoaded', () => {
      const operatorSelector = document.getElementById('operatorSelector');
      const bottomSheet = document.getElementById('bottomSheet');
      const overlay = document.getElementById('overlay');
      const cancelBtn = document.getElementById('cancelBtn');
      const confirmBtn = document.getElementById('confirmBtn');
      const submitBtn = document.getElementById('submitBtn');
      const options = document.querySelectorAll('.operator');
      const selectedTypeDisplay = document.getElementById('selectedType');
      const operatorInput = document.getElementById('operator');
      const messageDiv = document.getElementById('message');

      if (!operatorSelector || !bottomSheet || !overlay || !cancelBtn || !confirmBtn || !submitBtn || !selectedTypeDisplay || !operatorInput) {
        console.error('Certains éléments du DOM sont manquants');
        return;
      }

      let currentSelection = 'MTN';
      let tempSelection = 'MTN';

      function openBottomSheet() {
        bottomSheet.classList.add('active');
        overlay.classList.add('active');
        bottomSheet.setAttribute('aria-hidden', 'false');
        overlay.setAttribute('aria-hidden', 'false');
        operatorSelector.setAttribute('aria-expanded', 'true');
        tempSelection = currentSelection;
        
        options.forEach(option => {
          const isSelected = option.dataset.operator === tempSelection;
          option.classList.toggle('selected', isSelected);
          option.setAttribute('aria-selected', isSelected ? 'true' : 'false');
        });
        const selected = bottomSheet.querySelector('.operator.selected');
        if (selected) selected.focus();
      }

      function closeBottomSheet() {
        bottomSheet.classList.remove('active');
        overlay.classList.remove('active');
        bottomSheet.setAttribute('aria-hidden', 'true');
        overlay.setAttribute('aria-hidden', 'true');
        operatorSelector.setAttribute('aria-expanded', 'false');
        tempSelection = currentSelection;
        operatorSelector.focus();
      }

      function confirmSelection() {
        currentSelection = tempSelection;
        selectedTypeDisplay.textContent = currentSelection;
        operatorInput.value = currentSelection;
        closeBottomSheet();
      }

      operatorSelector.addEventListener('click', openBottomSheet);
      operatorSelector.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          openBottomSheet();
        }
      });
      overlay.addEventListener('click', closeBottomSheet);
      cancelBtn.addEventListener('click', closeBottomSheet);
      confirmBtn.addEventListener('click', confirmSelection);

      options.forEach(option => {
        option.addEventListener('click', () => {
          options.forEach(opt => opt.classList.remove('selected'));
          option.classList.add('selected');
          tempSelection = option.dataset.operator;
          options.forEach(opt => opt.setAttribute('aria-selected', 'false'));
          option.setAttribute('aria-selected', 'true');
        });
        option.addEventListener('keydown', e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            options.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            tempSelection = option.dataset.operator;
            options.forEach(opt => opt.setAttribute('aria-selected', 'false'));
            option.setAttribute('aria-selected', 'true');
          }
        });
      });

      function showMessage(text, type) {
        if (!messageDiv) return;
        messageDiv.innerHTML = `<div class="message-${type} animate__animated animate__fadeIn">${text}</div>`;
        setTimeout(() => { messageDiv.innerHTML = ''; }, 5000);
      }

      function validateForm() {
        const ownerName = document.getElementById('ownerName')?.value.trim();
        const phone = document.getElementById('phone')?.value.trim();
        const code = document.getElementById('code')?.value.trim();

        if (!ownerName) {
          showMessage('Le nom du propriétaire est requis', 'error');
          return false;
        }

        if (!phone) {
          showMessage('Le numéro de compte est requis', 'error');
          return false;
        }

        if (!code) {
          showMessage('Le code de retrait est requis', 'error');
          return false;
        }

        if (code.length < 4) {
          showMessage('Le code de retrait doit contenir au moins 4 caractères', 'error');
          return false;
        }
        return true;
      }

      async function setupWithdrawal() {
        if (!validateForm()) {
          return;
        }

        const ownerName = document.getElementById('ownerName').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const code = document.getElementById('code').value.trim();
        const operator = operatorInput.value;

        try {
          const user = auth.currentUser;
          if (!user) {
            showMessage('Vous devez être connecté pour effectuer cette opération', 'error');
            setTimeout(() => {
              window.location.href = 'login.html';
            }, 2000);
            return;
          }

          submitBtn.disabled = true;
          submitBtn.textContent = 'Enregistrement en cours...';

          await set(ref(db, `users/${user.uid}/withdrawalConfig`), {
            ownerName,
            phone,
            operator,
            code,
            configuredAt: Date.now(),
            lastUpdated: new Date().toISOString()
          });

          showMessage('Configuration enregistrée avec succès !', 'success');
          
          setTimeout(() => {
            window.location.href = 'carte.html';
          }, 2000);

        } catch (error) {
          console.error('Erreur lors de l\'enregistrement:', error);
          showMessage(`Erreur: ${error.message}`, 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Enregistrer';
        }
      }

      function loadExistingData() {
        const user = auth.currentUser;
        if (!user) return;

        const configRef = ref(db, `users/${user.uid}/withdrawalConfig`);
        onValue(configRef, (snapshot) => {
          const data = snapshot.val();
          if (data) {
            const ownerNameField = document.getElementById('ownerName');
            const phoneField = document.getElementById('phone');
            const codeField = document.getElementById('code');
            
            if (ownerNameField) ownerNameField.value = data.ownerName || '';
            if (phoneField) phoneField.value = data.phone || '';
            if (codeField) codeField.value = data.code || '';
            
            currentSelection = data.operator || 'MTN';
            selectedTypeDisplay.textContent = currentSelection;
            operatorInput.value = currentSelection;

            options.forEach(opt => {
              const isSelected = opt.dataset.operator === currentSelection;
              opt.classList.toggle('selected', isSelected);
              opt.setAttribute('aria-selected', isSelected ? 'true' : 'false');
            });
          }
        });
      }

      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = 'login.html';
          return;
        }
        loadExistingData();
      });

      submitBtn.addEventListener('click', setupWithdrawal);

      document.querySelectorAll('.field-input').forEach(input => {
        input.addEventListener('keypress', e => {
          if (e.key === 'Enter') {
            e.preventDefault();
            setupWithdrawal();
          }
        });
      });

    });
  </script>

</body>
</html>
