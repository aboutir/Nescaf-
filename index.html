<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nescafé - Connexion / Inscription</title>
<style>
  /* Reset et typographie */
  * { box-sizing: border-box; }
  body {
    margin: 0; padding: 0;
    background: #f0f2f8;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    display: flex; justify-content: center; align-items: flex-start;
    min-height: 100vh;
    padding-top: 80px;
  }
  .container {
    background: #fff;
    width: 360px;
    padding: 38px 28px 35px;
    border-radius: 16px;
    box-shadow:
      0 10px 30px rgba(0, 0, 0, 0.07),
      inset 0 0 20px rgba(255, 255, 255, 0.8);
  }
  .header {
    margin-bottom: 38px;
    font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
    font-weight: 700; font-size: 2rem;
    color: #2d3748;
    text-align: center;
    user-select: none;
    letter-spacing: 0.045em;
  }
  label {
    display: block; margin-bottom: 9px;
    font-weight: 600; font-size: 1rem;
    color: #4a5568;
  }
  :root {
    --border-snake: url('data:image/svg+xml;utf8,<svg fill="none" stroke="%232d3748" stroke-width="2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 12 Q6 2 12 12 T24 12"/></svg>');
    --border-snake-focus: url('data:image/svg+xml;utf8,<svg fill="none" stroke="%230a8f5d" stroke-width="2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M0 12 Q6 2 12 12 T24 12"/></svg>');
  }
  input[type="text"],
  input[type="tel"],
  input[type="password"],
  select {
    width: 100%;
    padding: 14px 20px;
    font-size: 1rem;
    font-weight: 600;
    letter-spacing: 0.03em;
    color: #2d3748;
    background-color: #fff;
    border: 5.5px solid transparent;
    border-radius: 14px;
    border-image-source: var(--border-snake);
    border-image-slice: 24;
    border-image-repeat: round;
    transition: border-image-source 0.35s ease, box-shadow 0.35s ease;
    box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
    font-family: inherit;
    appearance: none;
    cursor: pointer;
  }
  input[type="text"],
  input[type="tel"],
  input[type="password"] {
    cursor: text;
  }
  select {
    padding-right: 35px;
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg width='24' height='24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill='%234a5568' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
  }
  input::placeholder {
    color: #7a8499;
    font-weight: 400;
    letter-spacing: 0.02em;
  }
  input:focus,
  select:focus {
    border-image-source: var(--border-snake-focus);
    box-shadow: 0 0 8px rgba(10, 143, 93, 0.5);
    outline: none;
    color: #0a8f5d;
  }
  input[type="tel"] {
    padding-left: 20px;
    cursor: text;
  }
  button {
    margin-top: 15px;
    background-color: #2d3748;
    background-image: linear-gradient(145deg, #2d3748, #1a202c);
    color: #e2e8f0;
    width: 100%;
    padding: 16px 0;
    font-size: 1.15rem;
    font-weight: 700;
    border: 5.5px solid transparent;
    border-radius: 16px;
    border-image-source: var(--border-snake);
    border-image-slice: 24;
    border-image-repeat: round;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(45, 55, 72, 0.4);
    letter-spacing: 0.045em;
    transition: background-color 0.35s ease, border-image-source 0.3s ease, box-shadow 0.3s ease;
    font-family: inherit;
  }
  button:hover, button:focus {
    background-color: #0a8f5d;
    background-image: linear-gradient(145deg, #0a8f5d, #063d25);
    border-image-source: var(--border-snake-focus);
    box-shadow: 0 6px 20px rgba(10, 143, 93, 0.7);
    outline: none;
  }
  .links {
    margin-top: 22px;
    display: flex;
    justify-content: space-between;
    font-size: 1rem;
    color: #4a5568;
    font-weight: 600;
  }
  .links a {
    color: #718096;
    text-decoration: none;
    transition: color 0.25s ease;
    cursor: pointer;
  }
  .links a:hover, .links a:focus {
    color: #0a8f5d;
    text-decoration: underline;
    outline: none;
  }
  section {
    display: none;
  }
  section.active {
    display: block;
  }
  .sr-only {
    position: absolute;
    width: 1px; height: 1px;
    padding: 0; margin: -1px;
    overflow: hidden; clip: rect(0, 0, 0, 0);
    border: 0;
  }
  .referral-status {
    font-size: 0.9rem;
    margin-top: 4px;
    display: none;
  }
  .referral-status.valid {
    color: #0a8f5d;
    display: block;
  }
  .referral-status.invalid {
    color: #d53f3f;
    display: block;
  }
  .error-message {
    font-size: 0.9rem;
    color: #d53f3f;
    margin-top: 6px;
    display: none;
  }
  .success-message {
    font-size: 0.9rem;
    color: #0a8f5d;
    margin-top: 6px;
    display: none;
  }
  /* Style pour affichage code de parrainage reçu */
  #referralCodeDisplay {
    font-weight: 600;
    color: #0a8f5d;
    margin-bottom: 12px;
  }
</style>
</head>
<body>

<div class="container" role="main" aria-label="Formulaires de connexion et inscription Nescafé">

  <!-- Connexion -->
  <section id="login-section" class="active" aria-labelledby="login-header">
    <div class="header" id="login-header">Nescafé - Connexion</div>
    <form id="loginFormData" aria-describedby="loginDesc" novalidate>
      <div id="loginDesc" class="sr-only">Entrez votre numéro de téléphone et mot de passe pour vous connecter</div>

      <label for="loginCountry">Pays</label>
      <select id="loginCountry" name="loginCountry" aria-label="Sélectionner le pays">
        <option value="CI" selected>Côte d'Ivoire +225</option>
        <option value="ML">Mali +223</option>
        <option value="SN">Sénégal +221</option>
        <option value="BF">Burkina Faso +226</option>
        <option value="NE">Niger +227</option>
        <option value="BJ">Bénin +229</option>
        <option value="TG">Togo +228</option>
      </select>

      <label for="loginTelephone">Téléphone</label>
      <input type="tel" id="loginTelephone" name="loginTelephone" placeholder="" required aria-required="true" autocomplete="tel" />

      <div id="loginError" class="error-message" role="alert" aria-live="assertive"></div>

      <label for="loginPassword">Mot de passe</label>
      <input type="password" id="loginPassword" name="loginPassword" placeholder="Mot de passe" required aria-required="true" minlength="6" />

      <button type="submit">Se connecter</button>
    </form>

    <div class="links">
      <a id="switch-to-signup" role="link" tabindex="0">S'inscrire</a>
      <a href="#" role="link">Service client</a>
    </div>
  </section>

  <!-- Inscription -->
  <section id="signup-section" aria-labelledby="signup-header">
    <div class="header" id="signup-header">Nescafé - Inscription</div>

    <!-- Zone pour afficher le code de parrainage reçu via URL -->
    <div id="referralCodeDisplay" aria-live="polite" aria-atomic="true"></div>

    <form id="signupFormData" aria-describedby="signupDesc" novalidate>
      <div id="signupDesc" class="sr-only">
        Formulaire d'inscription avec nom complet, téléphone, mot de passe, confirmation et code de parrainage facultatif
      </div>

      <label for="signupUsername">Nom complet</label>
      <input type="text" id="signupUsername" name="signupUsername" placeholder="Votre nom complet" required aria-required="true" minlength="3" />

      <label for="signupCountry">Pays</label>
      <select id="signupCountry" name="signupCountry" aria-label="Sélectionner le pays">
        <option value="CI" selected>Côte d'Ivoire +225</option>
        <option value="ML">Mali +223</option>
        <option value="SN">Sénégal +221</option>
        <option value="BF">Burkina Faso +226</option>
        <option value="NE">Niger +227</option>
        <option value="BJ">Bénin +229</option>
        <option value="TG">Togo +228</option>
      </select>

      <label for="signupTelephone">Téléphone</label>
      <input type="tel" id="signupTelephone" name="signupTelephone" placeholder="" required aria-required="true" autocomplete="tel" />

      <div id="signupError" class="error-message" role="alert" aria-live="assertive"></div>
      <div id="signupSuccess" class="success-message" role="alert" aria-live="assertive"></div>

      <label for="signupPassword">Mot de passe</label>
      <input type="password" id="signupPassword" name="signupPassword" placeholder="Mot de passe" required aria-required="true" minlength="6" />

      <label for="confirmPassword">Confirmer le mot de passe</label>
      <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirmer mot de passe" required aria-required="true" minlength="6" />

      <label for="referralCode">Code de parrainage (facultatif)</label>
      <input type="text" id="referralCode" name="referralCode" placeholder="Saisissez un code de parrainage" autocomplete="off" />
      <div id="referralStatus" class="referral-status" aria-live="polite"></div>

      <button type="submit">S'inscrire</button>
    </form>

    <div class="links">
      <a id="switch-to-login" role="link" tabindex="0">Connexion</a>
      <a href="#" role="link">Service client</a>
    </div>
  </section>
</div>

<script>
  // Fonction pour basculer entre connexion et inscription
  function toggleForm() {
    const loginSection = document.getElementById('login-section');
    const signupSection = document.getElementById('signup-section');
    if (loginSection.style.display === 'none' || loginSection.classList.contains('hidden')) {
      loginSection.style.display = 'block';
      signupSection.style.display = 'none';
    } else {
      loginSection.style.display = 'none';
      signupSection.style.display = 'block';
    }
  }

  // Formats de numéro par pays
  const phoneFormats = {
    'CI': { code: '+225', format: 'XX XXX XXXX', example: '07 123 4567', pattern: /^[0-9]{2} [0-9]{3} [0-9]{4}$/ },
    'ML': { code: '+223', format: 'XX XX XX XX', example: '76 12 34 56', pattern: /^[0-9]{2} [0-9]{2} [0-9]{2} [0-9]{2}$/ },
    'SN': { code: '+221', format: 'XX XXX XX XX', example: '77 123 45 67', pattern: /^[0-9]{2} [0-9]{3} [0-9]{2} [0-9]{2}$/ },
    'BF': { code: '+226', format: 'XX XX XX XX', example: '70 12 34 56', pattern: /^[0-9]{2} [0-9]{2} [0-9]{2} [0-9]{2}$/ },
    'NE': { code: '+227', format: 'XX XX XX XX', example: '90 12 34 56', pattern: /^[0-9]{2} [0-9]{2} [0-9]{2} [0-9]{2}$/ },
    'BJ': { code: '+229', format: 'XX XX XX XX', example: '97 12 34 56', pattern: /^[0-9]{2} [0-9]{2} [0-9]{2} [0-9]{2}$/ },
    'TG': { code: '+228', format: 'XX XXX XXX', example: '90 123 456', pattern: /^[0-9]{2} [0-9]{3} [0-9]{3}$/ }
  };

  // Mise à jour du placeholder selon pays sélectionné
  function updatePhoneFormat(formType) {
    const country = document.getElementById(`${formType}Country`).value;
    const phoneFormat = phoneFormats[country];
    if (phoneFormat) {
      document.getElementById(`${formType}Telephone`).placeholder = phoneFormat.example;
    }
  }

  // Écouteurs sur changements pays pour mettre à jour les placeholders de téléphone
  document.getElementById('loginCountry').addEventListener('change', () => updatePhoneFormat('login'));
  document.getElementById('signupCountry').addEventListener('change', () => updatePhoneFormat('signup'));

  // Validation format téléphone au submit
  function validatePhoneFormat(formType, event) {
    const country = document.getElementById(`${formType}Country`).value;
    const phone = document.getElementById(`${formType}Telephone`).value.trim();
    const phoneFormat = phoneFormats[country];
    if (!phoneFormat.pattern.test(phone)) {
      event.preventDefault();
      document.getElementById(`${formType}Error`).textContent = `Format invalide. Utilisez le format: ${phoneFormat.format}`;
      document.getElementById(`${formType}Error`).style.display = 'block';
      return false;
    }
    document.getElementById(`${formType}Error`).style.display = 'none';
    return true;
  }

  // Validation code de parrainage au submit
  function validateReferralCode(event) {
    const referralCode = document.getElementById('referralCode').value.trim();
    const referralStatus = document.getElementById('referralStatus');
    if (referralCode.length > 0) {
      const isValid = /^[A-Z0-9]{6,8}$/.test(referralCode.toUpperCase());
      if (!isValid) {
        event.preventDefault();
        referralStatus.textContent = 'Code de parrainage invalide';
        referralStatus.className = 'referral-status invalid';
        referralStatus.style.display = 'block';
      } else {
        referralStatus.style.display = 'none';
      }
    }
  }

  // Récupérer paramètre URL 'ref'
  function getReferralCodeFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get('ref') || '';
  }

  // Afficher le code parrainage reçu et préremplir le champ inscription
  function displayReferralCodeFromURL() {
    const code = getReferralCodeFromURL();
    const displayElement = document.getElementById('referralCodeDisplay');
    if (code && displayElement) {
      displayElement.textContent = `Code de parrainage reçu : ${code}`;

      // Pré-remplissage du champ et déclenchement validation
      const referralInput = document.getElementById('referralCode');
      if (referralInput) {
        referralInput.value = code;
        referralInput.dispatchEvent(new Event('input'));
      }
    }
  }

  // Validation des soumis des formulaires
  document.getElementById('loginFormData').addEventListener('submit', (e) => {
    validatePhoneFormat('login', e);
  });
  document.getElementById('signupFormData').addEventListener('submit', (e) => {
    if (!validatePhoneFormat('signup', e)) return;
    validateReferralCode(e);
  });

  // Basculer entre formulaire connexion et inscription
  document.getElementById('switch-to-signup').addEventListener('click', toggleForm);
  document.getElementById('switch-to-login').addEventListener('click', toggleForm);

  // Vérification en temps réel du code de parrainage (pour message de validité)
  document.getElementById('referralCode').addEventListener('input', () => {
    const referralCodeInput = document.getElementById('referralCode').value.trim().toUpperCase();
    const referralStatus = document.getElementById('referralStatus');
    if (referralCodeInput.length > 0) {
      const isValid = /^[A-Z0-9]{6,8}$/.test(referralCodeInput);
      if (isValid) {
        referralStatus.textContent = 'Code valide';
        referralStatus.className = 'referral-status valid';
      } else {
        referralStatus.textContent = 'Code invalide';
        referralStatus.className = 'referral-status invalid';
      }
      referralStatus.style.display = 'block';
    } else {
      referralStatus.style.display = 'none';
    }
  });

  // Initialisations au chargement
  document.addEventListener('DOMContentLoaded', () => {
    updatePhoneFormat('login');
    updatePhoneFormat('signup');
    displayReferralCodeFromURL();
  });
</script>

<!-- Firebase et gestion formulaires -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getDatabase,
    ref,
    get,
    set
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  // Configuration Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBbnOxwcCXHAHJWxPw90YGvSuPCOyp6-lA",
    authDomain: "nescafe-cba7a.firebaseapp.com",
    databaseURL: "https://nescafe-cba7a-default-rtdb.firebaseio.com",
    projectId: "nescafe-cba7a",
    storageBucket: "nescafe-cba7a.firebasestorage.app",
    messagingSenderId: "91209018725",
    appId: "1:91209018725:web:adb0d2a8b458591c8a058c"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const database = getDatabase(app);

  class Utils {
    static generateReferralCode() {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      return Array.from({ length: 6 }, () =>
        chars.charAt(Math.floor(Math.random() * chars.length))
      ).join("");
    }

    static async checkReferralCode(code) {
      if (!code) return null;
      const snapshot = await get(ref(database, "users"));
      if (snapshot.exists()) {
        const users = snapshot.val();
        for (const userId in users) {
          if ((users[userId].referralCode ?? "").toUpperCase() === code.toUpperCase()) {
            return {
              userId,
              username: users[userId].username ?? ""
            };
          }
        }
      }
      return null;
    }

    static showError(id, message) {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = message;
        el.style.display = message ? "block" : "none";
      }
    }

    static showSuccess(id, message) {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = message;
        el.style.display = message ? "block" : "none";
      }
    }

    static clearMessages() {
      ["loginError", "signupError", "signupSuccess", "referralStatus"].forEach((id) => {
        const el = document.getElementById(id);
        if (el) {
          el.textContent = "";
          el.style.display = "none";
          el.className = el.className.replace(/(valid|invalid)/g, "").trim();
        }
      });
    }

    static updateReferralStatus(isValid, message) {
      const el = document.getElementById("referralStatus");
      if (el) {
        el.textContent = message;
        el.className = `referral-status ${isValid ? "valid" : "invalid"}`;
        el.style.display = message ? "block" : "none";
      }
    }
  }

  class FormManager {
    static async handleSignup(event) {
      event.preventDefault();
      Utils.clearMessages();

      try {
        const username = document.getElementById("signupUsername").value.trim();
        const telephone = document.getElementById("signupTelephone").value.trim();
        const email = `${telephone}@temp.com`;
        const password = document.getElementById("signupPassword").value;
        const confirmPassword = document.getElementById("confirmPassword").value;
        const referralCode = document.getElementById("referralCode").value.trim().toUpperCase();

        if (!username || !telephone || !password || !confirmPassword) {
          throw new Error("Veuillez remplir tous les champs requis");
        }
        if (password !== confirmPassword) {
          throw new Error("Les mots de passe ne correspondent pas");
        }
        if (password.length < 6) {
          throw new Error("Le mot de passe doit contenir au moins 6 caractères");
        }
        if (telephone.length < 8) {
          throw new Error("Numéro de téléphone invalide");
        }

        let referrerData = null;
        if (referralCode) {
          referrerData = await Utils.checkReferralCode(referralCode);
          if (!referrerData) {
            throw new Error("Code de parrainage invalide");
          }
        }

        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const newReferralCode = Utils.generateReferralCode();

        await set(ref(database, "users/" + user.uid), {
          username,
          email,
          phoneNumber: telephone,
          balance: referrerData ? 100 : 0,
          referralCode: newReferralCode,
          referredBy: referrerData?.userId || null,
          createdAt: Date.now()
        });

        if (referrerData?.userId) {
          const referrerRef = ref(database, `users/${referrerData.userId}`);
          const referrerSnapshot = await get(referrerRef);
          if (referrerSnapshot.exists()) {
            const currentBalance = referrerSnapshot.val().balance || 0;
            await set(ref(database, `users/${referrerData.userId}/balance`), currentBalance + 10);
          }
        }

        Utils.showSuccess("signupSuccess", "Compte créé avec succès ! Redirection...");
        setTimeout(() => window.location.href = "accueil.html", 1500);

      } catch (error) {
        Utils.showError("signupError", error.message);
      }
    }

    static async handleLogin(event) {
      event.preventDefault();
      Utils.clearMessages();

      try {
        const telephone = document.getElementById("loginTelephone").value.trim();
        const password = document.getElementById("loginPassword").value;

        if (!telephone || !password) {
          throw new Error("Veuillez remplir tous les champs");
        }

        const email = `${telephone}@temp.com`;
        await signInWithEmailAndPassword(auth, email, password);
        window.location.href = "accueil.html";

      } catch {
        Utils.showError("loginError", "Numéro ou mot de passe incorrect");
      }
    }

    static async handleReferralCodeInput() {
      const code = document.getElementById("referralCode").value.trim().toUpperCase();
      if (!code) {
        Utils.updateReferralStatus(true, "");
        return;
      }
      try {
        const referrerData = await Utils.checkReferralCode(code);
        if (referrerData) {
          Utils.updateReferralStatus(true, `Code valide ! Parrain: ${referrerData.username}`);
        } else {
          Utils.updateReferralStatus(false, "Code de parrainage invalide");
        }
      } catch {
        Utils.updateReferralStatus(false, "Erreur lors de la vérification du code");
      }
    }
  }

  // Debounce utilitaire
  function debounce(func, delay) {
    let timer;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => func.apply(this, args), delay);
    };
  }

  document.addEventListener("DOMContentLoaded", () => {
    const signupForm = document.getElementById("signupFormData");
    const loginForm = document.getElementById("loginFormData");
    const referralInput = document.getElementById("referralCode");

    if (signupForm) {
      signupForm.addEventListener("submit", (e) => {
        FormManager.handleSignup(e);
      });
    }
    if (loginForm) {
      loginForm.addEventListener("submit", (e) => {
        FormManager.handleLogin(e);
      });
    }
    if (referralInput) {
      referralInput.addEventListener("input", debounce(FormManager.handleReferralCodeInput, 500));
    }
  });

  onAuthStateChanged(auth, (user) => {
    if (user) {
      console.log("Utilisateur connecté:", user.uid);
    } else {
      console.log("Aucun utilisateur connecté");
    }
  });
</script>

</body>
</html>
