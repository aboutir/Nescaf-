<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Inscription / Connexion - NescafÃ© Investissement ðŸ’¯%</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

  body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #6a11cb, #2575fc);
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    color: #242424;
  }

  .container {
    background: #fff;
    border-radius: 16px;
    width: 420px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    overflow: hidden;
    border: 3px solid #6a11cb;
    transition: border-color 0.4s ease;
  }
  .container:hover {
    border-color: #2575fc;
  }

  header {
    background: linear-gradient(90deg, #6a11cb, #2575fc);
    color: white;
    padding: 30px 35px 15px;
    font-weight: 700;
    font-size: 1.8rem;
    text-align: center;
    letter-spacing: 1.2px;
    user-select: none;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  /* IcÃ´ne NescafÃ© Investissement */
  .logo {
    font-size: 2.4rem;
    line-height: 1;
    margin-bottom: 8px;
  }
  .logo span {
    font-weight: 900;
    font-style: italic;
    color: #fff3cd;
    text-shadow:
      1px 1px 2px rgba(0,0,0,0.4),
      0 0 10px #ffd700aa;
    user-select: none;
  }
  .logo .percent {
    font-size: 1.2rem;
    margin-left: 6px;
    color: #ffcc00;
  }

  /* Titre formulaire */
  #formTitle {
    margin: 0;
    font-size: 1.9rem;
    font-weight: 700;
    color: #ffdd57;
    text-shadow: 0 0 10px #ffdd57cc;
  }

  form {
    padding: 30px 35px;
  }

  form.hidden {
    display: none;
  }

  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 1.05rem;
    color: #551a8b;
    text-transform: uppercase;
    letter-spacing: 0.7px;
  }

  .inline-group {
    display: flex;
    gap: 12px;
    margin-bottom: 18px;
  }

  .inline-group > div {
    flex: 1;
  }

  input, select {
    width: 100%;
    padding: 12px 14px;
    border: 2px solid #d1d1d1;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 500;
    color: #333;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }

  input::placeholder {
    color: #aaa;
    font-style: italic;
  }

  input:focus, select:focus {
    border-color: #ffdd57;
    box-shadow: 0 0 10px #ffdd57bb;
    outline: none;
  }

  /* Style pour wrapper select + drapeau */
  .country-select-wrapper {
    position: relative;
  }

  .selected-flag {
    position: absolute;
    top: 50%;
    left: 12px;
    transform: translateY(-50%);
    font-size: 1.6rem;
    pointer-events: none;
    user-select: none;
  }

  select {
    padding-left: 45px !important; /* espace pour le drapeau */
  }

  /* SÃ©lecteurs avec drapeaux (emoji) */
  select option {
    padding-left: 25px;
  }

  /* Boutons */
  button {
    width: 100%;
    padding: 14px 0;
    background: linear-gradient(90deg, #ffb700, #ffdd57);
    border: none;
    border-radius: 12px;
    color: #551a8b;
    font-weight: 700;
    font-size: 1.2rem;
    cursor: pointer;
    user-select: none;
    transition: background 0.4s ease, transform 0.2s ease;
    box-shadow: 0 5px 15px #ffcc0099;
  }

  button:hover {
    background: linear-gradient(90deg, #ffdd57, #ffb700);
    transform: translateY(-2px);
    box-shadow: 0 8px 18px #ffcc00ee;
  }

  .toggle {
    text-align: center;
    margin: 20px 0 10px;
    font-size: 1rem;
    color: #551a8b;
    letter-spacing: 0.4px;
  }

  .toggle button {
    background: none;
    border: none;
    color: #ffb700;
    text-decoration: underline;
    cursor: pointer;
    font-weight: 700;
    font-size: 1rem;
    padding: 0;
    user-select: none;
  }
  .toggle button:hover {
    color: #ffdd57;
  }

  .error-message, .success-message, .referral-status {
    font-size: 0.9rem;
    margin-bottom: 18px;
    padding: 10px 14px;
    border-radius: 10px;
    display: none;
    font-weight: 600;
  }

  .error-message {
    background-color: #ffdbdb;
    color: #d93025;
  }

  .success-message {
    background-color: #defbe6;
    color: #137333;
  }

  .referral-status.valid {
    background-color: #defbe6;
    color: #137333;
    display: block;
  }
  .referral-status.invalid {
    background-color: #ffdede;
    color: #d93025;
    display: block;
  }

  @media (max-width: 440px) {
    .container {
      width: 95%;
      border-width: 2px;
    }
    .inline-group {
      flex-direction: column;
    }
  }
</style>
</head>
<body>

<div class="container" role="main" aria-label="Formulaire d'inscription et de connexion">

  <header>
    <div class="logo" aria-label="Logo NescafÃ© Investissement">
      <span>NescafÃ©</span> <span class="percent">Investissement ðŸ’¯%</span>
    </div>
    <h1 id="formTitle">Connexion</h1>
  </header>

  <!-- Formulaire Connexion -->
  <form id="loginFormData">
    <label for="loginCountry">Pays</label>
    <div class="country-select-wrapper">
      <span id="loginSelectedFlag" class="selected-flag" aria-hidden="true">ðŸ‡¨ðŸ‡®</span>
      <select id="loginCountry" name="loginCountry" aria-required="true" aria-describedby="loginCountryDesc">
        <option value="CI" data-flag="ðŸ‡¨ðŸ‡®" selected>CÃ´te d'Ivoire (+225)</option>
        <option value="ML" data-flag="ðŸ‡²ðŸ‡±">Mali (+223)</option>
        <option value="SN" data-flag="ðŸ‡¸ðŸ‡³">SÃ©nÃ©gal (+221)</option>
        <option value="BF" data-flag="ðŸ‡§ðŸ‡«">Burkina Faso (+226)</option>
        <option value="NE" data-flag="ðŸ‡³ðŸ‡ª">Niger (+227)</option>
        <option value="BJ" data-flag="ðŸ‡§ðŸ‡¯">BÃ©nin (+229)</option>
        <option value="TG" data-flag="ðŸ‡¹ðŸ‡¬">Togo (+228)</option>
      </select>
    </div>
    <span id="loginCountryDesc" class="sr-only">SÃ©lectionnez votre pays pour le format du numÃ©ro</span>

    <label for="loginTelephone">NumÃ©ro de tÃ©lÃ©phone</label>
    <input type="text" id="loginTelephone" name="loginTelephone" placeholder="" autocomplete="tel" aria-required="true" aria-describedby="loginError" />

    <label for="loginPassword">Mot de passe</label>
    <input type="password" id="loginPassword" name="loginPassword" autocomplete="current-password" aria-required="true" />
    
    <div id="loginError" class="error-message" role="alert" aria-live="assertive"></div>

    <button type="submit" aria-label="Se connecter">Se connecter</button>

    <div class="toggle" aria-live="polite">
      Pas encore inscrit ? <button type="button" id="switch-to-signup" aria-label="Basculer vers inscription">CrÃ©er un compte</button>
    </div>
  </form>

  <!-- Formulaire Inscription -->
  <form id="signupFormData" class="hidden" novalidate>
    <label for="signupUsername">Nom d'utilisateur</label>
    <input type="text" id="signupUsername" name="signupUsername" placeholder="Votre nom" autocomplete="username" aria-required="true"/>

    <div class="inline-group">
      <div class="country-select-wrapper">
        <label for="signupCountry">Pays</label>
        <span id="signupSelectedFlag" class="selected-flag" aria-hidden="true">ðŸ‡¨ðŸ‡®</span>
        <select id="signupCountry" name="signupCountry" aria-required="true" aria-describedby="signupCountryDesc">
          <option value="CI" data-flag="ðŸ‡¨ðŸ‡®" selected>CÃ´te d'Ivoire (+225)</option>
          <option value="ML" data-flag="ðŸ‡²ðŸ‡±">Mali (+223)</option>
          <option value="SN" data-flag="ðŸ‡¸ðŸ‡³">SÃ©nÃ©gal (+221)</option>
          <option value="BF" data-flag="ðŸ‡§ðŸ‡«">Burkina Faso (+226)</option>
          <option value="NE" data-flag="ðŸ‡³ðŸ‡ª">Niger (+227)</option>
          <option value="BJ" data-flag="ðŸ‡§ðŸ‡¯">BÃ©nin (+229)</option>
          <option value="TG" data-flag="ðŸ‡¹ðŸ‡¬">Togo (+228)</option>
        </select>
        <span id="signupCountryDesc" class="sr-only">SÃ©lectionnez votre pays pour le format du numÃ©ro</span>
      </div>
      <div>
        <label for="signupTelephone">NumÃ©ro de tÃ©lÃ©phone</label>
        <input type="text" id="signupTelephone" name="signupTelephone" placeholder="" autocomplete="tel" aria-required="true" aria-describedby="signupError" />
      </div>
    </div>

    <div class="inline-group">
      <div>
        <label for="signupPassword">Mot de passe</label>
        <input type="password" id="signupPassword" name="signupPassword" autocomplete="new-password" aria-required="true" />
      </div>
      <div>
        <label for="confirmPassword">Confirmez le mot de passe</label>
        <input type="password" id="confirmPassword" name="confirmPassword" autocomplete="new-password" aria-required="true" />
      </div>
    </div>

    <label for="referralCode">Code de parrainage (optionnel)</label>
    <input type="text" id="referralCode" name="referralCode" placeholder="Entrez le code parrain" aria-describedby="referralStatus" />

    <div id="referralStatus" class="referral-status" role="alert" aria-live="polite"></div>
    <div id="signupError" class="error-message" role="alert" aria-live="assertive"></div>
    <div id="signupSuccess" class="success-message" role="alert" aria-live="assertive"></div>

    <button type="submit" aria-label="S'inscrire">S'inscrire</button>

    <div class="toggle" aria-live="polite">
      DÃ©jÃ  un compte ? <button type="button" id="switch-to-login" aria-label="Basculer vers connexion">Se connecter</button>
    </div>
  </form>

</div>

<script>
  // Fonction pour basculer entre connexion et inscription
  function toggleForm() {
    const loginForm = document.getElementById('loginFormData');
    const signupForm = document.getElementById('signupFormData');
    const formTitle = document.getElementById('formTitle');
    if (loginForm.classList.contains('hidden')) {
      loginForm.classList.remove('hidden');
      signupForm.classList.add('hidden');
      formTitle.textContent = 'Connexion';
    } else {
      loginForm.classList.add('hidden');
      signupForm.classList.remove('hidden');
      formTitle.textContent = 'Inscription';
    }
  }

  // Suppression de la validation des formats tÃ©lÃ©phone et des placeholders formatÃ©s
  // const phoneFormats = { ... }; // La variable n'est plus nÃ©cessaire, elle peut Ãªtre supprimÃ©e si voulu

  // Met Ã  jour le drapeau affichÃ© Ã  gauche du select
  function updateSelectedFlag(formType) {
    const select = document.getElementById(formType + 'Country');
    const flagSpan = document.getElementById(formType + 'SelectedFlag');
    const selectedOption = select.options[select.selectedIndex];
    const flag = selectedOption.getAttribute('data-flag');
    if (flag) {
      flagSpan.textContent = flag;
    } else {
      flagSpan.textContent = '';
    }
  }

  // Validation code parrainage inchangÃ©e
  function validateReferralCode(event) {
    const code = document.getElementById('referralCode').value.trim();
    const status = document.getElementById('referralStatus');
    if (code.length > 0) {
      const valid = /^[A-Z0-9]{6,8}$/.test(code.toUpperCase());
      if (!valid) {
        event.preventDefault();
        status.textContent = 'Code de parrainage invalide';
        status.className = 'referral-status invalid';
        status.style.display = 'block';
      } else {
        status.style.display = 'none';
      }
    }
  }

  // *** AjoutÃ© : rÃ©cupÃ©ration du code de parrainage depuis l'URL ***
  function getReferralCodeFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get('ref') || '';
  }

  function displayReferralCodeFromURL() {
    const code = getReferralCodeFromURL();
    if (code) {
      const referralInput = document.getElementById('referralCode');
      const referralStatus = document.getElementById('referralStatus');
      if (referralInput && referralStatus) {
        const codeUpper = code.toUpperCase();
        referralInput.value = codeUpper;
        if (/^[A-Z0-9]{6,8}$/.test(codeUpper)) {
          referralStatus.textContent = `Code valide reÃ§u : ${codeUpper}`;
          referralStatus.className = 'referral-status valid';
        } else {
          referralStatus.textContent = 'Code de parrainage invalide';
          referralStatus.className = 'referral-status invalid';
        }
        referralStatus.style.display = "block";
      }
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    ['login', 'signup'].forEach(formType => {
      updateSelectedFlag(formType);
      document.getElementById(formType + 'Country').addEventListener('change', () => {
        updateSelectedFlag(formType);
      });
    });

    // Suppression des validations sur le tÃ©lÃ©phone au submit pour les deux formulaires
    document.getElementById('loginFormData').addEventListener('submit', e => {
      // Aucun contrÃ´le format tÃ©lÃ©phone ici
    });
    document.getElementById('signupFormData').addEventListener('submit', e => {
      // On supprime la validation format tÃ©lÃ©phone, mais on garde la validation du code parrain
      validateReferralCode(e);
    });

    document.getElementById('switch-to-signup').addEventListener('click', toggleForm);
    document.getElementById('switch-to-login').addEventListener('click', toggleForm);

    document.getElementById('referralCode').addEventListener('input', () => {
      const code = document.getElementById('referralCode').value.trim().toUpperCase();
      const status = document.getElementById('referralStatus');
      if (code.length > 0) {
        const valid = /^[A-Z0-9]{6,8}$/.test(code);
        status.textContent = valid ? 'Code valide' : 'Code invalide';
        status.className = 'referral-status ' + (valid ? 'valid' : 'invalid');
        status.style.display = 'block';
      } else {
        status.style.display = 'none';
      }
    });

    // Affiche le code parrainage depuis l'URL
    displayReferralCodeFromURL();
  });

</script>

<!-- Firebase scripts etc. Ã  insÃ©rer ici comme avant -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    getDatabase,
    ref,
    get,
    set
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

  // Configuration Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBbnOxwcCXHAHJWxPw90YGvSuPCOyp6-lA",
    authDomain: "nescafe-cba7a.firebaseapp.com",
    databaseURL: "https://nescafe-cba7a-default-rtdb.firebaseio.com",
    projectId: "nescafe-cba7a",
    storageBucket: "nescafe-cba7a.firebasestorage.app",
    messagingSenderId: "91209018725",
    appId: "1:91209018725:web:adb0d2a8b458591c8a058c"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const database = getDatabase(app);

  class Utils {
    static generateReferralCode() {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      return Array.from({ length: 6 }, () =>
        chars.charAt(Math.floor(Math.random() * chars.length))
      ).join("");
    }

    static async checkReferralCode(code) {
      if (!code) return null;
      const snapshot = await get(ref(database, "users"));
      if (snapshot.exists()) {
        const users = snapshot.val();
        for (const userId in users) {
          if ((users[userId].referralCode ?? "").toUpperCase() === code.toUpperCase()) {
            return {
              userId,
              username: users[userId].username ?? ""
            };
          }
        }
      }
      return null;
    }

    static showError(id, message) {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = message;
        el.style.display = message ? "block" : "none";
      }
    }

    static showSuccess(id, message) {
      const el = document.getElementById(id);
      if (el) {
        el.textContent = message;
        el.style.display = message ? "block" : "none";
      }
    }

    static clearMessages() {
      ["loginError", "signupError", "signupSuccess", "referralStatus"].forEach((id) => {
        const el = document.getElementById(id);
        if (el) {
          el.textContent = "";
          el.style.display = "none";
          el.className = el.className.replace(/(valid|invalid)/g, "").trim();
        }
      });
    }

    static updateReferralStatus(isValid, message) {
      const el = document.getElementById("referralStatus");
      if (el) {
        el.textContent = message;
        el.className = `referral-status ${isValid ? "valid" : "invalid"}`;
        el.style.display = message ? "block" : "none";
      }
    }
  }

  class FormManager {
    static async handleSignup(event) {
      event.preventDefault();
      Utils.clearMessages();

      try {
        const username = document.getElementById("signupUsername").value.trim();
        const telephone = document.getElementById("signupTelephone").value.trim();
        const email = `${telephone}@temp.com`;
        const password = document.getElementById("signupPassword").value;
        const confirmPassword = document.getElementById("confirmPassword").value;
        const referralCode = document.getElementById("referralCode").value.trim().toUpperCase();

        if (!username || !telephone || !password || !confirmPassword) {
          throw new Error("Veuillez remplir tous les champs requis");
        }
        if (password !== confirmPassword) {
          throw new Error("Les mots de passe ne correspondent pas");
        }
        if (password.length < 6) {
          throw new Error("Le mot de passe doit contenir au moins 6 caractÃ¨res");
        }
        if (telephone.length < 1) {
          throw new Error("NumÃ©ro de tÃ©lÃ©phone invalide");
        }

        let referrerData = null;
        if (referralCode) {
          referrerData = await Utils.checkReferralCode(referralCode);
          if (!referrerData) {
            throw new Error("Code de parrainage invalide");
          }
        }

        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const newReferralCode = Utils.generateReferralCode();

        await set(ref(database, "users/" + user.uid), {
          username,
          email,
          phoneNumber: telephone,
          balance: referrerData ? 100 : 0,
          referralCode: newReferralCode,
          referredBy: referrerData?.userId || null,
          createdAt: Date.now()
        });

        if (referrerData?.userId) {
          const referrerRef = ref(database, `users/${referrerData.userId}`);
          const referrerSnapshot = await get(referrerRef);
          if (referrerSnapshot.exists()) {
            const currentBalance = referrerSnapshot.val().balance || 0;
            await set(ref(database, `users/${referrerData.userId}/balance`), currentBalance + 10);
          }
        }

        Utils.showSuccess("signupSuccess", "Compte crÃ©Ã© avec succÃ¨s ! Redirection...");
        setTimeout(() => window.location.href = "accueil.html", 1500);

      } catch (error) {
        Utils.showError("signupError", error.message);
      }
    }

    static async handleLogin(event) {
      event.preventDefault();
      Utils.clearMessages();

      try {
        const telephone = document.getElementById("loginTelephone").value.trim();
        const password = document.getElementById("loginPassword").value;

        if (!telephone || !password) {
          throw new Error("Veuillez remplir tous les champs");
        }

        const email = `${telephone}@temp.com`;
        await signInWithEmailAndPassword(auth, email, password);
        window.location.href = "accueil.html";

      } catch {
        Utils.showError("loginError", "NumÃ©ro ou mot de passe incorrect");
      }
    }

    static async handleReferralCodeInput() {
      const code = document.getElementById("referralCode").value.trim().toUpperCase();
      if (!code) {
        Utils.updateReferralStatus(true, "");
        return;
      }
      try {
        const referrerData = await Utils.checkReferralCode(code);
        if (referrerData) {
          Utils.updateReferralStatus(true, `Code valide ! Parrain: ${referrerData.username}`);
        } else {
          Utils.updateReferralStatus(false, "Code de parrainage invalide");
        }
      } catch {
        Utils.updateReferralStatus(false, "Erreur lors de la vÃ©rification du code");
      }
    }
  }

  // Debounce utilitaire
  function debounce(func, delay) {
    let timer;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => func.apply(this, args), delay);
    };
  }

  document.addEventListener("DOMContentLoaded", () => {
    const signupForm = document.getElementById("signupFormData");
    const loginForm = document.getElementById("loginFormData");
    const referralInput = document.getElementById("referralCode");

    if (signupForm) {
      signupForm.addEventListener("submit", (e) => {
        FormManager.handleSignup(e);
      });
    }
    if (loginForm) {
      loginForm.addEventListener("submit", (e) => {
        FormManager.handleLogin(e);
      });
    }
    if (referralInput) {
      referralInput.addEventListener("input", debounce(FormManager.handleReferralCodeInput, 500));
    }
  });

  onAuthStateChanged(auth, (user) => {
    if (user) {
      console.log("Utilisateur connectÃ©:", user.uid);
    } else {
      console.log("Aucun utilisateur connectÃ©");
    }
  });
</script>

</body>
</html>
